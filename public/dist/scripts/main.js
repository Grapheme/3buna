function arrayObjectIndexOf(e,r,o){for(var t=0,a=e.length;a>t;t++)if(e[t][o]===r)return t;return-1}function triads(e){return e=e.toString(),e.replace(/(\d)(?=(\d\d\d)+([^\d]|$))/g,"$1 ")}function jsTils(e,r){var o;return count=e%100,count>=5&&count<=20?o=r[2]:(count%=10,o=1==count?r[0]:count>=2&&count<=4?r[1]:r[2]),o}function localstorageGet(e,r){return Modernizr.localstorage?localStorage.getItem(e)?JSON.parse(localStorage.getItem(e)):!1:void(r=r||function(){})}function localstorageSet(e,r,o){Modernizr.localstorage&&localStorage.setItem(e,JSON.stringify(r)),(o=o||function(){})()}console.log("'Allo 'Allo!"),$(function(){function e(e){t.slideUp(),t.eq(e).slideDown()}function r(){$activeBtn=o.filter(".active"),index=o.index($activeBtn),e(index)}var o=$(".tabs-btn>a"),t=$(".tabs>.tab");r(),o.click(function(e){e.preventDefault(),$(this).is(".active")||(o.removeClass("active"),$(this).addClass("active"),_mapMarkers_.forEach(function(e){e.marker.balloon.close()}),r())})});var _mapMarkers_=[];$(function(){function e(){var e=localstorageGet("billboards_ids");$(".billboards #list-view tr").removeClass("ordered"),_mapMarkers_.forEach(function(e){var r=e.marker.properties.get("type");e.marker.properties.set("btn_type","Заказать"),e.marker.properties.set("ordered",""),e.marker.options.set("iconImageHref",a[r])}),e&&e.forEach(function(e){$(".billboards #list-view tr[data-id="+e+"]").addClass("ordered"),_mapMarkers_.forEach(function(r){if(e==r.id){var o=r.marker.properties.get("type");r.marker.properties.set("btn_type","Отменить"),r.marker.properties.set("ordered","ordered"),r.marker.options.set("iconImageHref",i[o])}})})}function r(){var e=localstorageGet("billboards_ids"),r=0,o=0;if(e){e.forEach(function(e){billboards_json.items.forEach(function(t){e==t.id&&(r+=1,o+=t.price)})});var t=jsTils(r,["Выбран ","Выбрано ","Выбрано "])+r+jsTils(r,[" щит"," щита"," щитов"]);o=triads(o),s.find(".count").text(t),s.find(".numbers").text(o+" рублей."),0==r?s.hide():s.show()}else s.hide()}function o(){"undefined"!=typeof billboards_json&&localstorageSet("billboards_json",billboards_json.items)}function t(){if($("#request-form .selected-billboards").size()){var e=localstorageGet("billboards_ids"),r=localstorageGet("billboards_json");e&&r&&e.length>0?e.forEach(function(e){r.forEach(function(r){e==r.id&&$('<div class="unit" data-id="'+r.id+'">'+r.address+'<a href="" class="close"></a></div>').prependTo("#request-form .selected-billboards .list")})}):($("#request-form .selected-billboards .title").text("Вы не выбрали ни одного щита."),$("#request-form .selected-billboards .more a").text("Добавить щит"))}}var a={yellow:"/images/ico-marker_yellow.png",green:"/images/ico-marker_green.png",red:"/images/ico-marker_red.png"},i={yellow:"/images/ico-marker_yellow_ordered.png",green:"/images/ico-marker_green_ordered.png",red:"/images/ico-marker_red_ordered.png"};"undefined"!=typeof billboards_json&&ymaps.ready(function(){var e=new ymaps.Map("billboard-map",{center:billboards_json.center,zoom:billboards_json.zoom}),r=ymaps.templateLayoutFactory.createClass('<div class="billboard-mark">          <div class="mark {{properties.type}}"></div><div class="address">{{properties.address}}</div>          <div class="info">            <span class="reserved">{{properties.reserved}}<strong>{{properties.strong}}</strong>,<br>            <strong>{{properties.price}} руб.</strong></div>          <a href="{{properties.photo}}" class="photo">Фото</a><br>          <a href="" data-id="{{properties.id}}" class="order {{properties.ordered}}">{{properties.btn_type}}</a>        </div>',{});e.behaviors.disable("scrollZoom"),$.each(billboards_json.items,function(o,t){var i="";if(t.reserved){var s="Зарезервирован до ";i=t.reserved}else if(t.available){var s="Доступно через ";i=t.available+jsTils(t.available,[" день"," дня"," дней"])}else var s="Доступен";var l=new ymaps.Placemark(t.position,{type:t.type,address:t.address,reserved:s,strong:i,price:triads(t.price),photo:t.photo,id:t.id,btn_type:"Заказать",ordered:""},{balloonContentLayout:r,balloonPanelMaxMapArea:0,balloonMaxWidth:500,iconLayout:"default#image",iconImageHref:a[t.type],iconImageSize:[53,65]});l.events.add("balloonopen",function(){console.log("balloonopen!")}),_mapMarkers_.push({id:t.id,marker:l}),e.geoObjects.add(l)})});var s=$(".tabs-btn .selected");if("undefined"!=typeof billboards_json){var l=".billboards #list-view .order a, .billboard-mark .order";$(document).on("click",l,function(o){var t=$(this).closest("tr").attr("data-id")||$(this).attr("data-id");if(localstorageGet("billboards_ids"))var a=localstorageGet("billboards_ids");else var a=[];if($(this).is(".ordered")||$(this).closest("tr").is(".ordered")){var a=localstorageGet("billboards_ids");a.splice(a.indexOf(t),1)}else-1==a.indexOf(t)&&a.push(t);localstorageSet("billboards_ids",a),o.preventDefault(),r(),e()}),r(),e()}$(".billboards #list-view .price .numbers").each(function(){var e=$(this).text();$(this).text(triads(e))}),o(),$(document).on("click","#request-form .selected-billboards .unit .close",function(e){var r=$(this).attr("data-id"),o=localstorageGet("billboards_ids");o.splice(o.indexOf(r),1);var a=$(this);localstorageSet("billboards_ids",o,function(){a.closest(".unit").fadeOut(300,function(){0==o.length&&t()})}),e.preventDefault()}),t(),$("#request-form").validate({rules:{org:"required",phone:"required"},messages:{org:"Обязательное поле",phone:"Обязательное поле"},submitHandler:function(e){var r=localstorageGet("billboards_ids");return $(e).find('input[name="billboards"]').val(JSON.stringify(r)),$.ajax({type:$(e).attr("method"),url:$(e).attr("action"),data:$(e).serialize()}).done(function(){$("#request-form .wrapper").slideUp(),$("#request-form .final").slideDown()}),!1}})}),$(function(){function e(e,r){r=r||function(){};var o=e.magnificPopup({type:"image",removalDelay:500,callbacks:{beforeOpen:function(){this.st.image.markup=this.st.image.markup.replace("mfp-figure","mfp-figure mfp-with-anim"),this.st.mainClass="mfp-move-from-top"},close:function(){r()}},closeOnContentClick:!0,showCloseBtn:!1,tLoading:"Загрузка..."});return o}e($("#list-view td.photo a")),$(document).on("click",".billboard-mark .photo",function(r){r.preventDefault(),e($(this)).magnificPopup("open")})});